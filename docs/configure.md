# Configure a Simulation

HYDRAD requires setting many different configuration files, making it difficult and tedious to configure a simulation by hand. Fortunately, the `hydrad_tools` package makes it easy to quickly configure a new simulation using Python.

Rather than editing each configuration file individually, an entire simulation can be configured using a single [Python dictionary](https://docs.python.org/3/library/stdtypes.html#dict). Below is an example of a dictionary for configuring a simulation of a 80 Mm loop lasting 5000 s with a single heating pulse using an adaptive grid. Many of the configuration options have been excluded for brevity. A complete list of configuration parameters can be found in the [section below](#configuration-parameters).

```python
>>> import astropy.units as u
>>> config_dict = {
        'general': {
            'total_time': 5e3 * u.s,
            'loop_length': 80 * u.Mm,
            'footpoint_height': 5e8 * u.cm,
            # ... other config parameters ...
        },
        'initial_conditions': {
            'footpoint_temperature': 2e4 * u.K,
            'footpoint_density': 1e11 * u.cm**(-3),
            'isothermal': False,
            # ... other config parameters ...
        },
        'radiation': {
            'use_power_law_radiative_losses': True,
            # ... other config parameters ...
        },
        'heating': {
            'heat_electrons': True,
            'background_heating': True,
            'events': [
                {'time_start': 0.*u.s, 'rise_duration': 100*u.s,
                'decay_duration': 100*u.s, 'total_duration': 200*u.s,
                'location': 4e9*u.cm, 'scale_height': 1e300 * u.cm,
                'rate': 0.1 *u.erg/u.s/(u.cm**3), },
            ],
        },
        'solver': {
            'safety_radiation': 1.0,
            'safety_conduction': 1.0,
            'safety_advection': 1.0,
            'safety_atomic': 1.0,
            # ... other grid parameters ...
        },
        'grid': {
            'adapt': True,
            # ... other grid parameters ...
        }
    } 
```

The next step is to pass it to the `hydrad_tools` class which can parse it and print the needed configuration files,

```python
>>> from hydrad_tools import configure
>>> c = configure.Configure(config)
```

And we can preview the different configuration files that setup the HYDRAD simulation,
```python
>>> print(c.initial_conditions_header)
```
```c++
// ****
// *
// * #defines for configuring the hydrostatic model
// *
// * (c) Dr. Stephen J. Bradshaw
// *
// * Source code generated by hydrad_tools on 2018-03-26_00.38.59
// *
// ****

// **** Output ****
// **** End of Output ****

// **** Physics ****
#include "../../Radiation_Model/source/config.h"



// **** Solver ****
#define EPSILON 0.01

// **** Grid ****
#define ADAPT
#define MIN_CELLS 150
#define MAX_CELLS 30000
#define MAX_REFINEMENT_LEVEL 12
#define MIN_DS 1.0
#define MAX_VARIATION 1.1
```
```python
>>> print(c.initial_conditions_cfg)
```
```
Initial_Conditions/profiles/initial.amr

8000000000.0
0.0
500000000.0

20000.0

100000000000.0

4000000000.0
1e+300
-8.0
2.0
0.001
10000.0

Configuration file generated by hydrad_tools on 2018-03-26_00.42.20
```
```python
>>> print(c.hydrad_header)
```
```c++
// ****
// *
// * #defines for configuring the hydrodynamic model
// *
// * (c) Dr. Stephen J. Bradshaw
// *
// * Source code generated by hydrad_tools on 2018-03-26_00.59.38
// *
// ****

// **** Output ****
#define WRITE_FILE_PHYSICAL




#define OUTPUT_EVERY_N_TIME_STEPS 1000
// **** End of Output ****

// **** Physics ****
#include "../../Heating_Model/source/config.h"
#include "../../Radiation_Model/source/config.h"
#define HEAT_FLUX_LIMITING_COEFFICIENT 1.0
#define TIME_STEP_LIMIT 1e-10

#include "collisions.h"


// **** End of Physics ****

// **** Solver ****
#define SAFETY_RADIATION 1.0
#define SAFETY_CONDUCTION 1.0
#define SAFETY_ADVECTION 1.0
#define SAFETY_VISCOSITY 1.0
#define TIME_STEP_INCREASE_LIMIT 1.05

#define MINIMUM_RADIATION_TEMPERATURE 20000.0
#define ZERO_OVER_TEMPERATURE_INTERVAL 500.0
#define MINIMUM_TEMPERATURE 10000.0
// **** End of Solver ****

// **** Grid ****
#define MAX_REFINEMENT_LEVEL 12
#define ADAPT

#define REFINE_ON_ELECTRON_ENERGY

#define MIN_FRAC_DIFF 0.1
#define MAX_FRAC_DIFF 0.2
#define LINEAR_RESTRICTION

// **** End of Grid ****
```

To print all configuration files, run the initial conditions, and copy all of this to a new location,

```python
c.setup_simulation('/path/to/simulation/dir', base_path='/path/to/clean/HYDRAD', 
                   name='new_hydrad_sim')
```

This will create all of the needed input files from the options in `config`, compile the initial conditions code, run `Initial_Conditions.exe`, compile the main HYDRAD, and copy it all to the directory `/path/to/simulation/dir/new_hydrad_sim`.

## Setting a Default Configuration

HYDRAD requires a lot of configuration options and it can be annoying to have put them all in a configuration file. To avoid this, you can load a default configuration from an [ASDF file](https://asdf.readthedocs.io), a human-readable, structured plain text file in the YAML format.

These ASDF files are structured just like the config directory and can be easily read and written. As an example, a configuration file might look like, 

```YAML
#ASDF 1.0.0
#ASDF_STANDARD 1.2.0
%YAML 1.1
%TAG ! tag:stsci.edu:asdf/
--- !core/asdf-1.1.0
asdf_library: !core/software-1.0.0 {author: Space Telescope Science Institute, homepage: 'http://github.com/spacetelescope/asdf',
  name: asdf, version: 2.0.1}
history:
  extensions:
  - !core/extension_metadata-1.0.0
    extension_class: asdf.extension.BuiltinExtension
    software: {name: asdf, version: 2.0.1}
  - !core/extension_metadata-1.0.0
    extension_class: astropy.io.misc.asdf.extension.AstropyAsdfExtension
    software: {name: astropy, version: 3.0.1}
general:
  footpoint_height: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm', value: 500000000.0}
  force_single_fluid: false
  heat_flux_limiting_coefficient: 0.16666666666666666
  heat_flux_timestep_limit: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's', value: 1.0e-10}
  logging_frequency: 1000
  loop_inclination: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'deg', value: 0.0}
  loop_length: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'Mm', value: 80.0}
  minimum_collisional_coupling_timescale: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's',
    value: 0.01}
  output_interval: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's', value: 5.0}
  total_time: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's', value: 50000.0}
  use_kinetic_model: false
  write_file_equation_terms: false
  write_file_hydrogen_level_populations: false
  write_file_ion_populations: false
  write_file_physical: true
  write_file_timescales: false
grid:
  adapt: true
  adapt_every_n_time_steps: 10
  enforce_conservation: false
  linear_restriction: true
  maximum_cells: 30000
  maximum_fractional_difference: 0.2
  maximum_refinement_level: 12
  maximum_variation: 0.1
  minimum_cells: 150
  minimum_delta_s: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm', value: 1.0}
  minimum_fractional_difference: 0.1
  refine_on_density: true
  refine_on_electron_energy: true
  refine_on_hydrogen_energy: false
heating:
  alfven_wave_heating: false
  background_heating: false
  beam_heating: false
  events:
  - decay_duration: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's', value: 100.0}
    location: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm', value: 4000000000.0}
    rate: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm-3 erg s-1', value: 0.1}
    rise_duration: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's', value: 100.0}
    scale_height: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm', value: 1.0e+300}
    time_start: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's', value: 0.0}
    total_duration: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 's', value: 200.0}
  heat_electrons: true
initial_conditions:
  footpoint_density: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm-3', value: 100000000000.0}
  footpoint_temperature: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'K', value: 20000.0}
  heating_location: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'Mm', value: 40.0}
  heating_range_fine_tuning: 10000.0
  heating_range_lower_bound: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm-3 erg
      s-1', value: 1.0e-08}
  heating_range_step_size: 0.01
  heating_range_upper_bound: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm-3 erg
      s-1', value: 100.0}
  heating_scale_height: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm', value: 1.0e+300}
  isothermal: false
  use_tabulated_gravity: false
radiation:
  abundance_dataset: asplund
  decouple_ionization_state_solver: false
  density_dependent_rates: false
  elements_equilibrium: [Fe]
  elements_nonequilibrium: []
  emissivity_dataset: chianti_v7
  nlte_chromosphere: false
  optically_thick_radiation: false
  ranges_dataset: ranges
  rates_dataset: chianti_v7
  use_power_law_radiative_losses: true
solver:
  cutoff_ion_fraction: 1.0e-06
  epsilon: 0.01
  epsilon_d: 0.1
  epsilon_r: 1.8649415311920072
  maximum_optically_thin_density: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'cm-3',
    value: 1000000000000.0}
  minimum_radiation_temperature: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'K',
    value: 20000.0}
  minimum_temperature: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'K', value: 10000.0}
  safety_advection: 1.0
  safety_atomic: 1.0
  safety_conduction: 1.0
  safety_radiation: 0.1
  safety_viscosity: 1.0
  timestep_increase_limit: 0.05
  zero_over_temperature_interval: !unit/quantity-1.1.0 {unit: !unit/unit-1.0.0 'K',
    value: 500.0}
...
```

To load a configuration from a file,

```python
config = configure.Configure.load_config('/path/to/config/defaults.asdf')
# Update configuration options in config
c = configure.Configure(config)
```

And to save the configuration to disk,

```python
c.save_config('/path/to/config/my_config.asdf')
```

An example default configuration file can be found in the root of the [hydrad_tools repository](https://github.com/wtbarnes/hydrad_tools).

## Overriding Default Templates

If you make local modifications to the HYDRAD code, you may need configuration options not in the included templates. To use custom configuration options, you can inject your own modified templates of the configuration files which take advantage of any custom options. 

To see the available templates,

```python
>>> c.templates
['coefficients.cfg',
 'collisions.h',
 'heating.cfg',
 'heating.config.h',
 'hydrad.cfg',
 'hydrad.config.h',
 'initial_conditions.cfg',
 'initial_conditions.config.h',
 'radiation.config.h',
 'radiation.elements.cfg']
```

Say we want to add an option, `MY_NEW_PARAM` to the `collisions.h` file. To get the current unrendered template,

```python
>>> print(c.get_raw_template('collisions.h'))
```
```
// ****
// *
// * #defines for configuring the shortest collisional coupling timescale
// *
// * (c) Dr. Stephen J. Bradshaw
// *
// * Source code generated by hydrad_tools on {{ date }}
// *
// ****

// **** Physics ****
#define MINIMUM_COLLISIONAL_COUPLING_TIME_SCALE {{ general.minimum_collisional_coupling_timescale | units_filter('s') }}
{% if general.force_single_fluid -%}#define FORCE_SINGLE_FLUID{%- endif %}
// **** End of Physics ****
```

We can then create a new template with our new value,

```python
new_collisions = """// ****
// *
// * #defines for configuring the shortest collisional coupling timescale
// *
// * (c) Dr. Stephen J. Bradshaw
// *
// * Source code generated by hydrad_tools on {{ date }}
// *
// ****

// **** Physics ****
#define MINIMUM_COLLISIONAL_COUPLING_TIME_SCALE {{ general.minimum_collisional_coupling_timescale | units_filter('s') }}
{% if general.force_single_fluid -%}#define FORCE_SINGLE_FLUID{%- endif %}
// **** End of Physics ****
#define MY_NEW_PARAM {{ general.my_new_param }}"""
```

add our new parameter to the configuration directory,

```python
config['general']['my_new_param'] = 100
```

and then pass the template to the `Configure` object,

```python
c_new = Configure(config, templates={'collisions.h': new_collisions})
```

Now take a look at your custom rendered template,

```python
>>> print(c_new.collisions_header)
```
```
// ****
// *
// * #defines for configuring the shortest collisional coupling timescale
// *
// * (c) Dr. Stephen J. Bradshaw
// *
// * Source code generated by hydrad_tools on 2018-09-01_15.14.17
// *
// ****

// **** Physics ****
#define MINIMUM_COLLISIONAL_COUPLING_TIME_SCALE 0.01

// **** End of Physics ****
#define MY_NEW_PARAM 100
```

## Configuration Parameters

The tables below give an exhaustive list of all of the different HYDRAD configuration options. If the units are listed, the input must have units that can be converted to the listed unit with the [Astropy units module](http://docs.astropy.org/en/stable/units/), e.g. `loop_length` can be input in Mm.

### General

| Name | Description | Type | Units |
|:----:|:------------|:----:|:-----:|
| total_time | Total duration of the simulation | `int` | s |
| output_interval | How often results are printed to file | `int` | s |
| loop_length | Footpoint-to-footpoint distance of the coronal loop | `float` | cm |
| loop_inclination | Angle between loop and surface normal | `float` | degree |
| footpoint_height | Length of the chromosphere | `float` | cm |
| tabulated_gravity_profile | Coefficients (in order of increasing exponent) for 6th order polynomial fit to the field-aligned gravitational acceleration | array-like | |
| tabulated_cross_section_profile | Coefficients (in order of increasing exponent) for 6th order polynomial fit to the field-aligned gravitational acceleration | array-like | |
| logging_frequency | Frequency (in number of timesteps) that progress is printed to the screen | `int` | |
| initial_amr_file | Adaptive mesh file to initialize loop from; if not given, uses the result from the initial conditions code | `str` | |
| write_file_physical | Toggle writing `.phy` solutions file | `bool` | |
| write_file_ion_populations | Toggle writing `.ine` file | `bool` | |
| write_file_hydrogen_level_populations | Toggle writing `.Hstate` file | `bool` | |
| write_file_timescales | Toggle writing `.scl` file | `bool` | |
| write_file_equation_terms | Toggle writing `.trm` | `bool` | |
| heat_flux_limiting_coefficient | See Eq. A15 of [BC13]| `float` | |
| heat_flux_timestep_limit | Minimum value the heat flux will limit timestep to | `float` | s |
| use_kinetic_model | Toggle using kinetic model for heat flux | `bool` | |
| minimum_collisional_coupling_timescale |  | `float` | s |
| force_single_fluid | If true, force electron and ion quantities to be equal | `bool` | |

[BC13]: http://adsabs.harvard.edu/abs/2013ApJ...770...12B

### Initial Conditions

| Name | Description | Type | Units |
|:----:|:------------|:----:|:-----|
| use_tabulated_gravity | If true, read gravitational profile from file | `bool` | |
| footpoint_temperature | Temperature at the loop footpoint | `float` | K
| footpoint_density | Density at the loop footpoint | `float` | cm$^{-3}$|
| heating_location | Loop coordinate where equilibrium heat is injected | `float` | cm |
| heating_scale_height | Spatial scale of the injected equilibrium heating | `float` | cm |
| isothermal | If true, inital temperature profile is uniform | `bool` | |
| heating_range_lower_bound | Lower bound on rate search range| `float` | $\mathrm{erg}\,\mathrm{cm}^{-3}\,\mathrm{s}^{-1}$  |
| heating_range_upper_bound | Upper bound on rate search range| `float` | $\mathrm{erg}\,\mathrm{cm}^{-3}\,\mathrm{s}^{-1}$  |
| heating_range_step_size | Resolution of heating search range | `float` | |
| heating_range_fine_tuning | | `float` | |

### Heating

| Name | Description | Type | Units |
|:----:|:------------|:----:|:-----:|
| heat_electrons | If false, only ions are heated | `bool` | |
| beam_heating | Toggle beam heating model | `bool` | |
| alfven_wave_heating | Toggle Alfvén wave heating model | `bool` | |
| background_heating | If true, use equilibrium heating from initial conditions as steady background heating | `bool` | |
| events | List of heating event properties | `list` | |

Each entry in the `events` list should be a dictionary with the following seven keys (and appropriate units) corresponding to each heating event,

| Name | Units |
|:-----:|:-------:|
| time_start | s |
| rise_duration | s |
| decay_duration | s |
| total_duration | s |
| location | cm |
| scale_height | cm |
| rate | $\mathrm{erg}\,\mathrm{cm}^{-3}\,\mathrm{s}^{-1}$ |

### Radiation

| Name | Description | Type | Units |
|:----:|:------------|:----:|:------|
| use_power_law_radiative_losses | If true, use piecewise power-law to calculate radiative losses | `bool` | |
| decouple_ionization_state_solver | | `bool` | |
| density_dependent_rates | | `bool` | |
| optically_thick_radiation | If true, include optically thick lines in radiative losses | `bool` | |
| nlte_chromosphere | | `bool` | |
| ranges_dataset | Temperature and density ranges dataset | `str` | |
| emissivity_dataset | Name of emissivity dataset | `str` | |
| abundance_dataset | Name of abundance dataset | `str` | |
| rates_dataset | Name of ionization/recombination rates dataset | `str` | |
| elements_equilibrium | Assume ionization equilibrium when calculating these population fractions | `list` | |
| elements_nonequilibrium | Account for time-dependent ionization when calculating these population fractions | `list` | |

In the lists of equilibrium and non-equilibrium elements, each entry can either be the atomic symbol, number, or the element name. As an example, each entry in the list below (which includes hydrogen, helium, carbon, and iron) is a valid element identifier,
```python
elements = ['hydrogen', 'He', 'c', 26]
```

### Solver

| Name | Description | Type | Units |
|:----:|:------------|:----:|:-----:|
| epsilon | | `float` | |
| safety_radiation | | `float` | |
| safety_conduction | | `float` | |
| safety_advection | | `float` | |
| safety_atomic | | `float` | |
| safety_viscosity | | `float` | |
| cutoff_ion_fraction | Population fractions below this value are set to 0 | `float` | |
| epsilon_d | Safety factor for ion population solver; see [B09] | `float` | |
| epsilon_r | Safety factor for ion population solver; see [B09] | `float` | |
| timestep_increase_limit | Allowed fractional difference (between 0 and 1) from 1 timestep to next | `float` | |
| relative_viscous_timescale | | `float` | |
| minimum_radiation_temperature | | `float` | K |
| zero_over_temperature_interval | Temperature interval over which the chromospheric radiative losses are set to zero | `float` | K |
| minimum_temperature | | `float` | K |
| maximum_optically_thin_density | | `float` | $\mathrm{cm}^{-3}$ |

[B09]: http://adsabs.harvard.edu/abs/2009A%26A...502..409B

### Grid

| Name | Description | Type | Units |
|:----:|:------------|:----:|:-----:|
| adapt | Toggle using adaptive mesh refinement | `bool` | |
| adapt_every_n_time_steps | How often to adapt on time step | `int` | |
| minimum_cells | | `int` | |
| maximum_cells | | `int` | |
| maximum_refinement_level | How much to refine adaptive grid; see [BC13] | `int` | |
| minimum_delta_s | Smallest allowed grid cell width in the initial setup | `float` | cm |
| maximum_variation | | `float` | |
| refine_on_density | | `bool` | |
| refine_on_electron_energy | | `bool` | |
| refine_on_hydrogen_energy | | `bool` | |
| minimum_fractional_difference | Minimum allowed difference (between 0 and 1) between adjacent cells | `float` | |
| maximum_fractional_difference | Maximum allowed difference (between 0 and 1) between adjacent cells | `float` | |
| linear_restriction | | `bool` | |
| enforce_conservation | | `bool` | |
